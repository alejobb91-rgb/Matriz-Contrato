<form id="formSocialObra" autocomplete="off">
  <h3>Social Obra</h3>
  <label>No. Contrato:<br>
    <select id="contratoSocialObra" required>
      <!-- Opciones generadas dinámicamente con los No. Contrato existentes -->
    </select>
  </label><br><br>

  <label>Subdirección Responsable:<br>
    <select id="subdireccionObra" required>
      <option value="">Seleccione...</option>
      <option value="SGDU">SGDU</option>
      <option value="SGI">SGI</option>
      <option value="DTINI">DTINI</option>
      <option value="DTP">DTP</option>
      <option value="DTC">DTC</option>
      <option value="DTCI">DTCI</option>
      <option value="DTAI">DTAI</option>
      <option value="STEP">STEP</option>
      <option value="STED">STED</option>
      <option value="STAP">STAP</option>
      <option value="STGSV">STGSV</option>
      <option value="STESV">STESV</option>
      <option value="STEST">STEST</option>
      <option value="STCSV">STCSV</option>
      <option value="STCST">STCST</option>
    </select>
  </label><br><br>

  <label>Nombre Coordinador Técnico:<br>
    <input type="text" id="coordinadorObra" required>
  </label><br><br>

  <label>Celular:<br>
    <input type="text" id="celularObra" required maxlength="15">
    <span id="errorCelularObra" style="color:red;display:none;"></span>
  </label><br><br>

  <label>Correo Electrónico:<br>
    <input type="email" id="correoObra" required>
    <span id="errorCorreoObra" style="color:red;display:none;"></span>
  </label><br><br>

  <button type="submit">Asociar Social Obra</button>
</form>
<div id="msgSocialObra"></div>

<script>
  // Cargar opciones de No. Contrato desde localStorage
  function cargarContratosObra() {
    let contratos = JSON.parse(localStorage.getItem('contratos') || "[]");
    let select = document.getElementById('contratoSocialObra');
    select.innerHTML = '<option value="">Seleccione...</option>' +
      contratos.map(c => `<option value="${c.noContrato}">${c.noContrato}</option>`).join('');
  }
  cargarContratosObra();

  // Validación en tiempo real celular
  document.getElementById('celularObra').addEventListener('input', function() {
    const celular = this.value.trim();
    const errorSpan = document.getElementById('errorCelularObra');
    if (!/^[0-9]{7,15}$/.test(celular)) {
      errorSpan.textContent = 'El celular solo debe contener números y mínimo 7 dígitos.';
      errorSpan.style.display = 'inline';
    } else {
      errorSpan.textContent = '';
      errorSpan.style.display = 'none';
    }
  });

  // Validación en tiempo real correo
  document.getElementById('correoObra').addEventListener('input', function() {
    const correo = this.value.trim();
    const errorSpan = document.getElementById('errorCorreoObra');
    const correoValido = /^[\w\.-]+@[\w\.-]+\.\w+$/.test(correo);
    if (!correoValido) {
      errorSpan.textContent = 'Ingrese un correo electrónico válido.';
      errorSpan.style.display = 'inline';
    } else {
      errorSpan.textContent = '';
      errorSpan.style.display = 'none';
    }
  });

  document.getElementById('formSocialObra').onsubmit = function(e) {
    e.preventDefault();
    const celular = document.getElementById('celularObra').value.trim();
    const correo = document.getElementById('correoObra').value.trim();
    const celularValido = /^[0-9]{7,15}$/.test(celular);
    const correoValido = /^[\w\.-]+@[\w\.-]+\.\w+$/.test(correo);

    if (!celularValido) {
      document.getElementById('msgSocialObra').innerHTML = `<span style="color:red">El celular solo debe contener números y mínimo 7 dígitos.</span>`;
      return;
    }
    if (!correoValido) {
      document.getElementById('msgSocialObra').innerHTML = `<span style="color:red">Ingrese un correo electrónico válido.</span>`;
      return;
    }

    const datos = {
      noContrato: document.getElementById('contratoSocialObra').value,
      subdireccion: document.getElementById('subdireccionObra').value,
      coordinador: document.getElementById('coordinadorObra').value.trim(),
      celular: celular,
      correo: correo
    };

    let asociados = JSON.parse(localStorage.getItem('asociarSocialObra') || "[]");
    // Validación de duplicados por No. Contrato y Coordinador Técnico
    const existe = asociados.some(a => 
      a.noContrato === datos.noContrato &&
      a.coordinador.toLowerCase() === datos.coordinador.toLowerCase()
    );
    if (existe) {
      document.getElementById('msgSocialObra').innerHTML = `<span style="color:red">Ya existe una asociación para este No. Contrato y Nombre Coordinador Técnico.</span>`;
      return;
    }

    asociados.push(datos);
    localStorage.setItem('asociarSocialObra', JSON.stringify(asociados));
    document.getElementById('msgSocialObra').innerHTML = `
      <b>Social Obra asociado correctamente:</b>
      <ul>
        <li><b>No. Contrato:</b> ${datos.noContrato}</li>
        <li><b>Subdirección Responsable:</b> ${datos.subdireccion}</li>
        <li><b>Nombre Coordinador Técnico:</b> ${datos.coordinador}</li>
        <li><b>Celular:</b> ${datos.celular}</li>
        <li><b>Correo Electrónico:</b> ${datos.correo}</li>
      </ul>
    `;
    document.getElementById('formSocialObra').reset();
    cargarContratosObra();
  };
</script>